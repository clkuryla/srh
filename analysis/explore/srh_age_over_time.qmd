---
title: "SRH-Age Over Time Phenomenon"
author: "Christine L. Kuryla"
format: 
  html:
    toc: true
    toc-location: left
    toc-depth: 3
  gfm:
    toc: true
editor: visual
execute:
  echo: false
  message: false
  warning: false
code-fold: true
code-tools: true
---

# SRH-Age Relationship over Time

**Purpose**: Determine the relationship between age and SRH (Self-Rated Health) over time using six datasets.

**Data**: MEPS, BRFSS, NHIS, GSS, CPS, NHANES

**Outputs**: Visualizations and tables of:

1. Weighted mean SRH by age group over time. 

2. Weighted regression results showing the relationship between age and SRH over time for different age groups.

#### Load packages and source functions
```{r}
library(tidyverse)
library(here)
source(here::here("R/paths.R")) # To access path for data as depot_path and derived_path
ensure_dirs()

source(here::here("R/srh_common_functions.R")) # Common SRH functions
source(here::here("old_code/srh_and_age_over_time.R")) # Functions for this analysis/exploration

library(srvyr)
library(knitr)

```

#### Load data
```{r}
#| label: load-data

data_meps <- readr::read_rds(derived_path("data_meps.rds")) |> 
  select(srh, age, year, psu, wt, strata) |>
  filter(wt != 0) |>
  drop_na(srh, age, year, wt) |>
  add_age_group(scheme = "B", new_var = age_group)

data_nhis <- readr::read_rds(derived_path("data_nhis.rds")) |> 
  select(srh, age, year, psu, wt, strata) |>
  filter(wt != 0) |>
  drop_na(srh, age, year, wt) |>
  add_age_group(scheme = "B", new_var = age_group)

data_gss <- readr::read_rds(derived_path("data_gss.rds")) |> 
  select(srh, age, year, wt) |>
  filter(wt != 0) |>
  drop_na(srh, age, year, wt) |>
  add_age_group(scheme = "B", new_var = age_group)

data_cps <- readr::read_rds(derived_path("data_cps.rds")) |> 
  select(srh, age, year, wt) |>
  filter(wt != 0) |>
  drop_na(srh, age, year, wt) |>
  add_age_group(scheme = "B", new_var = age_group)

data_nhanes <- readr::read_rds(derived_path("data_nhanes.rds")) |> 
  select(srh, age, year, psu, wt, strata) |>
  filter(wt != 0) |>
  drop_na(srh, age, year, wt) |>
  add_age_group(scheme = "B", new_var = age_group)

```


# SRH per age group over time (figures and tables)

## NHIS
```{r}
#| label: mean-srh

srh_means_meps <- summarize_srh_over_time(data_meps, 
                                          survey_name = "MEPS") 



srh_means_nhis <- summarize_srh_over_time(data_nhis, 
                                          survey_name = "NHIS") 

srh_means_gss <- summarize_srh_over_time(data_gss, 
                                          survey_name = "GSS") 

srh_means_cps <- summarize_srh_over_time(data_cps, 
                                          survey_name = "CPS") 

srh_means_nhanes <- summarize_srh_over_time(data_nhanes, 
                                          survey_name = "NHANES") 


srh_means_meps$plot                                          
srh_means_nhis$plot
srh_means_gss$plot
srh_means_cps$plot
srh_means_nhanes$plot

table_render(
  srh_means_nhis$estimates,
  caption = "Table. Self-rated health by age group and year (NHIS)")


```