---
title: "BHAPC Covariate Sensitivity Analysis — Internal Working Notes"
author: "Christine L. Kuryla"
date: today
format:
  gfm:
    toc: true
execute:
  echo: true
  message: false
  warning: false
---

# Overview

These are internal working notes for the BHAPC covariate sensitivity analysis
testing whether observed birth cohort effects on SRH are explained by
compositional changes in demographics and psychological distress (K6).

**Core question:** Do cohort effects in the BHAPC model shrink or disappear
once we control for race, education, sex, and K6 (Kessler-6 psychological
distress)?

**Scripts:** `R/scripts/17_bhapc_nhis_meps_covariates.R` (orchestrator) →
`17a` (MEPS models), `17b` (NHIS models) → `17c` (combined comparison figure),
`17d` (4x3 APC grids), `17e` (2x4 period/cohort figures)

**Output directory:** `output/bhapc_nhis_meps_covariates/`


# Setup

```{r}
#| label: setup

library(tidyverse)
library(here)
library(knitr)

output_dir <- here::here("output", "bhapc_nhis_meps_covariates")
```


# Model Specifications

Four nested models, each building on the last:

| Model | Formula (random effects: cohort + period) | What it tests |
|-------|-------------------------------------------|---------------|
| **M1** (base) | `srh ~ age + age² + lnWt + (1|cohort) + (1|period)` | Baseline APC decomposition |
| **M2** (demographics) | M1 + `race + education + sex` | Compositional demographics |
| **M3** (K6 only) | M1 + `K6` | Psychological distress alone |
| **M4** (full) | M1 + `race + education + sex + K6` | All covariates combined |

**Design decisions:**

- **100k subsample:** Stan MCMC is computationally intensive; 100k observations
  balances precision with feasibility (~8-12 hours per model).
- **lnWt as covariate:** Following Graf (2021), log-transformed survey weights
  partially account for complex sampling designs within the Bayesian framework.
- **NHIS restricted to 1997+:** Education variable not consistently available
  before 1997 in the harmonized NHIS data.
- **4-year bins:** Age (18-21, 22-25, ..., 85-89), period, and cohort
  (period - age midpoint) all use 4-year bins.
- **MCMC config:** 4 chains × 6,000 iterations (3,000 warmup + 3,000 sampling),
  adapt_delta = 0.998, default weakly informative priors via rstanarm.


# Missingness

K6 availability is the main data concern. Models M3 and M4 are fit only on
complete cases for all covariates including K6.

```{r}
#| label: missingness

miss_meps <- read_csv(file.path(output_dir, "meps", "missingness_report.csv"),
                      show_col_types = FALSE)
miss_nhis <- read_csv(file.path(output_dir, "nhis", "missingness_report.csv"),
                      show_col_types = FALSE)

cat("=== MEPS Missingness ===\n")
kable(miss_meps, digits = 1)
```

```{r}
#| label: missingness-nhis

cat("\n=== NHIS Missingness ===\n")
kable(miss_nhis, digits = 1)
```

**Key observations:**

- MEPS K6: 25.9% missing (74,078 valid of 100,000)
- NHIS K6: **57.7% missing** (42,293 valid of 100,000) — much higher than MEPS
- This means M3/M4 for NHIS are fit on a substantially reduced subsample
- Core variables (SRH, age, year, weight) are complete in both surveys
- Education: 0.7% missing in MEPS, 2.1% in NHIS


# Convergence Diagnostics

```{r}
#| label: convergence

conv_meps <- read_csv(file.path(output_dir, "meps", "convergence_diagnostics.csv"),
                      show_col_types = FALSE)
conv_nhis <- read_csv(file.path(output_dir, "nhis", "convergence_diagnostics.csv"),
                      show_col_types = FALSE)

conv_all <- bind_rows(
  conv_meps |> mutate(survey = "MEPS"),
  conv_nhis |> mutate(survey = "NHIS")
) |>
  select(survey, model, max_rhat, min_neff, converged)

kable(conv_all, digits = 4, caption = "Convergence diagnostics for all 8 models")
```

All 8 models converged: max Rhat < 1.01, min effective sample size > 1,800.
No divergent transition concerns at adapt_delta = 0.998.


# Variance Decomposition

This is the core result. If covariates explain the cohort effect, cohort
variance should shrink from M1 → M4.

```{r}
#| label: variance-comparison

comp_meps <- read_csv(file.path(output_dir, "meps", "comparison_table.csv"),
                      show_col_types = FALSE)
comp_nhis <- read_csv(file.path(output_dir, "nhis", "comparison_table.csv"),
                      show_col_types = FALSE)

cat("=== MEPS Variance Decomposition (% of total) ===\n")
kable(comp_meps, digits = 3)
```

```{r}
#| label: variance-nhis

cat("\n=== NHIS Variance Decomposition (% of total) ===\n")
kable(comp_nhis, digits = 3)
```

### Percent Reduction in Cohort Variance (M1 → M4)

```{r}
#| label: variance-reduction

# Extract cohort row
meps_cohort <- comp_meps |> filter(component == "Cohort")
nhis_cohort <- comp_nhis |> filter(component == "Cohort")

meps_reduction <- (meps_cohort$M1_base - meps_cohort$M4_full) / meps_cohort$M1_base * 100
nhis_reduction <- (nhis_cohort$M1_base - nhis_cohort$M4_full) / nhis_cohort$M1_base * 100

# Period reduction
meps_period <- comp_meps |> filter(component == "Period")
nhis_period <- comp_nhis |> filter(component == "Period")

meps_period_red <- (meps_period$M1_base - meps_period$M4_full) / meps_period$M1_base * 100

cat("MEPS cohort variance reduction (M1 → M4):", round(meps_reduction, 1), "%\n")
cat("NHIS cohort variance reduction (M1 → M4):", round(nhis_reduction, 1), "%\n")
cat("\nMEPS period variance reduction (M1 → M4):", round(meps_period_red, 1), "%\n")
```

**Interpretation:**

- **MEPS:** Cohort variance drops from 1.45% → 0.36% (≈75% reduction). The
  biggest jump is M2→M3 (demographics→K6), suggesting K6 is the key driver.
- **NHIS:** Cohort variance drops from 0.50% → 0.08% (≈85% reduction). Again,
  adding K6 produces the largest reduction.
- Period variance in MEPS also drops substantially (0.44% → 0.05%).
- NHIS period effects behave oddly — they *increase* with demographics (M2),
  possibly due to correlation between period and education trends.

### Detailed Variance by Model

```{r}
#| label: variance-detail

# Load individual variance files for more detail
surveys <- c("meps", "nhis")
models <- paste0("m", 1:4)

var_all <- map_dfr(surveys, function(svy) {
  map_dfr(models, function(m) {
    read_csv(file.path(output_dir, svy, paste0("variance_", m, ".csv")),
             show_col_types = FALSE) |>
      mutate(survey = toupper(svy), model = toupper(m))
  })
})

var_summary <- var_all |>
  filter(component != "Total") |>
  select(survey, model, component, variance, pct_of_total) |>
  arrange(survey, model, component)

kable(var_summary, digits = 4,
      caption = "Detailed variance decomposition by survey and model")
```


# Fixed Effects

```{r}
#| label: fixed-effects

# Load all fixed effects
fe_all <- map_dfr(surveys, function(svy) {
  map_dfr(models, function(m) {
    read_csv(file.path(output_dir, svy, paste0("fixed_effects_", m, ".csv")),
             show_col_types = FALSE) |>
      mutate(survey = toupper(svy), model = toupper(m))
  })
})

# Key coefficients across models
key_terms <- c("age", "lnWt", "k6",
               "race_fNH Black", "race_fNH-Black",
               "educ_fBachelor+", "sex_fMale")

fe_key <- fe_all |>
  filter(term %in% key_terms) |>
  select(survey, model, term, estimate, std_error, ci_lower_90, ci_upper_90) |>
  arrange(survey, term, model)

kable(fe_key, digits = 4,
      caption = "Key fixed effects across models")
```

### K6 Coefficient

```{r}
#| label: k6-coefficient

fe_k6 <- fe_all |>
  filter(term == "k6") |>
  select(survey, model, estimate, std_error, ci_lower_90, ci_upper_90)

kable(fe_k6, digits = 4, caption = "K6 coefficient by survey and model")
```

K6 effect is strongly negative and consistent:

- **MEPS M3:** β_K6 = -0.097 (without demographics)
- **MEPS M4:** β_K6 = -0.094 (with demographics)
- **NHIS M3:** β_K6 = -0.091
- **NHIS M4:** β_K6 = -0.086

Each unit increase in K6 (higher distress) is associated with ≈0.09 lower SRH,
controlling for age and other covariates. Very stable across specifications.

### lnWt Coefficient

```{r}
#| label: lnwt-coefficient

fe_lnwt <- fe_all |>
  filter(term == "lnWt") |>
  select(survey, model, estimate, std_error)

kable(fe_lnwt, digits = 4, caption = "lnWt coefficient by survey and model")
```

**Key MEPS vs NHIS difference:** The lnWt coefficient is much larger in MEPS
(0.21 in M1, shrinking to 0.07 in M4) than in NHIS (≈0 across all models).
This suggests MEPS survey weights carry more information about SRH-relevant
characteristics. The substantial drop in MEPS lnWt from M1→M4 indicates that
the covariates (especially K6) absorb what the weight was proxying for.

See also: `R/scripts/21_sanity_check_combined.R` for the lnWt sensitivity
analysis without lnWt.


# Period and Cohort Effects — Figures

## Combined Covariate Comparison

This figure compares cohort effects across M1–M4 for both surveys side by side.

```{r}
#| label: fig-combined-comparison
#| fig-cap: "Combined covariate comparison: cohort effects across models and surveys"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "combined_covariate_comparison.png"))
```

**Reading this figure:** Each panel shows the posterior mean cohort random
effects (with 90% CIs) for one model. As we move from M1 → M4, the cohort
effects flatten toward zero, indicating that the covariates absorb the
between-cohort variation in SRH.


## MEPS: Period and Cohort Effects (2x4)

```{r}
#| label: fig-meps-2x4
#| fig-cap: "MEPS period and cohort effects across four models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "meps_figure_2x4_period_cohort.png"))
```


## NHIS: Period and Cohort Effects (2x4)

```{r}
#| label: fig-nhis-2x4
#| fig-cap: "NHIS period and cohort effects across four models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "nhis_figure_2x4_period_cohort.png"))
```


## MEPS: Full APC Grid (4x3)

```{r}
#| label: fig-meps-4x3
#| fig-cap: "MEPS age, period, and cohort effects across four models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "meps_figure3_4x3.png"))
```


## NHIS: Full APC Grid (4x3)

```{r}
#| label: fig-nhis-4x3
#| fig-cap: "NHIS age, period, and cohort effects across four models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "nhis_figure3_4x3.png"))
```


## Cohort Effects Close-Up

```{r}
#| label: fig-meps-cohort
#| fig-cap: "MEPS cohort effects comparison across models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "meps", "cohort_effects_comparison.png"))
```

```{r}
#| label: fig-nhis-cohort
#| fig-cap: "NHIS cohort effects comparison across models"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "nhis", "cohort_effects_comparison.png"))
```


## Individual M4 APC Panels

```{r}
#| label: fig-meps-m4
#| fig-cap: "MEPS M4 (full model) APC effects"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "meps", "figure3_m4.png"))
```

```{r}
#| label: fig-nhis-m4
#| fig-cap: "NHIS M4 (full model) APC effects"

knitr::include_graphics(here::here("output", "bhapc_nhis_meps_covariates",
                                    "nhis", "figure3_m4.png"))
```


# Interpretation

## What drives the MEPS vs NHIS difference?

1. **Baseline cohort variance is larger in MEPS** (1.45% vs 0.50%). MEPS may
   capture more health-relevant cohort variation due to its expenditure/
   utilization focus and panel structure.

2. **K6 missingness differs dramatically:** MEPS retains 74% of observations
   for K6 models; NHIS retains only 42%. The NHIS K6 models are fit on a more
   selected subsample, which could affect the apparent reduction.

3. **lnWt plays a bigger role in MEPS:** The weight coefficient is substantial
   in MEPS (0.21) and near-zero in NHIS. As covariates are added, MEPS lnWt
   shrinks (0.21 → 0.07), suggesting the weights proxy for health-related
   characteristics that the covariates now capture directly.

4. **NHIS period effects are anomalous:** Period variance *increases* from M1
   to M2, possibly because education trends are confounded with period in NHIS
   (1997+ restriction means education composition changes systematically across
   periods).

## Key takeaway

In both surveys, **K6 is the most powerful single covariate** for explaining
cohort variation in SRH. Adding demographics alone (M2) reduces cohort variance
by ~40-45%, but adding K6 (M3 or M4) reduces it by 75-85%. This is consistent
with the compositional hypothesis: apparent cohort "effects" on SRH are
substantially explained by rising psychological distress in younger cohorts.

## Caveats

- **Cross-sectional identification:** BHAPC still relies on functional form
  assumptions to separate APC effects. The covariate analysis is more robust
  (does K6 absorb cohort variance?) but not causal.
- **K6 missingness is non-random:** Respondents missing K6 may differ
  systematically from those with valid K6 scores.
- **100k subsample:** Results may differ slightly with the full sample, though
  the subsample is random.
- **lnWt sensitivity:** Separate analysis (`output/bhapc_sensitivity_no_lnwt/`)
  confirms main findings hold without the lnWt covariate.


# Technical Notes

## Script lineage

```
17_bhapc_nhis_meps_covariates.R   ← Orchestrator (sources 17a and 17b)
  ├── 17a_bhapc_meps_covariates.R ← Fits M1-M4 for MEPS, saves CSVs + RDS
  ├── 17b_bhapc_nhis_covariates.R ← Fits M1-M4 for NHIS, saves CSVs + RDS
  ├── 17c_combined_covariate_figure.R ← Combined comparison figure
  ├── 17d_nhis_meps_4x3_apc_figures.R ← 4x3 APC grid figures
  └── 17e_nhis_meps_2x4_period_cohort.R ← 2x4 period/cohort figures
```

## Output paths

- **CSVs:** `output/bhapc_nhis_meps_covariates/{meps,nhis}/`
  - `comparison_table.csv`, `convergence_diagnostics.csv`, `missingness_report.csv`
  - `fixed_effects_m{1-4}.csv`, `variance_m{1-4}.csv`
- **Model objects:** `output/bhapc_nhis_meps_covariates/{meps,nhis}/bhapc_m{1-4}.rds`
- **Figures (top-level):** `output/bhapc_nhis_meps_covariates/`
  - `combined_covariate_comparison.{png,pdf}`
  - `{meps,nhis}_figure3_4x3.{png,pdf}`
  - `{meps,nhis}_figure_2x4_period_cohort.{png,pdf}`
- **Figures (per-survey):** `output/bhapc_nhis_meps_covariates/{meps,nhis}/`
  - `cohort_effects_comparison.png`, `figure3_m4.png`

## Related analyses

- **lnWt sensitivity:** `output/bhapc_sensitivity_no_lnwt/` — confirms results
  hold without the survey weight covariate
- **Full random effects (6 surveys):** `output/bhapc_full_random/` — baseline
  BHAPC without covariates across all surveys
- **Methods text:** `output/methods_bhapc.md`


# Session Info

```{r}
#| label: session-info

sessionInfo()
```
