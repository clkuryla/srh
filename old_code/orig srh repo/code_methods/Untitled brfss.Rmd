---
title: "BRFSS Further Analyses"
author: "Christine Lucille Kuryla"
date: "2025-09-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(survey)
library(broom)

# Function 1: Create coefficient plots from weighted regressions
plot_regression_coefficients <- function(svy_data, 
                                        predictors, 
                                        outcome, 
                                        age_var = "age_decade_cat",
                                        year_var = "year",
                                        colors = NULL,
                                        overall_title = "Coefficient Trends by Age Group",
                                        y_label = "Coefficient",
                                        x_label = "Year") {
  
  # Default colors if not provided
  if(is.null(colors)) {
    colors <- c("#E91E63", "#8BC34A", "#2196F3", "#FF9800", "#9C27B0", 
                "lightpink", "gold", "mediumblue", "gray")
  }
  
  # Get unique age groups
  age_groups <- unique(svy_data$variables[[age_var]])
  age_groups <- age_groups[!is.na(age_groups)]
  
  # Get unique years
  years <- unique(svy_data$variables[[year_var]])
  years <- sort(years[!is.na(years)])
  
  # Initialize results data frame
  results_df <- data.frame()
  
  # Loop through age groups and years
  for(age in age_groups) {
    for(yr in years) {
      # Subset survey data
      svy_subset <- subset(svy_data, 
                          get(age_var) == age & get(year_var) == yr)
      
      # Check if subset has enough data
      if(nrow(svy_subset$variables) > 30) {
        # Build formula
        formula_str <- paste(outcome, "~", paste(predictors, collapse = " + "))
        formula_obj <- as.formula(formula_str)
        
        # Try to fit model
        tryCatch({
          model <- svyglm(formula_obj, design = svy_subset)
          
          # Extract coefficients with confidence intervals
          coef_summary <- tidy(model, conf.int = TRUE, conf.level = 0.95)
          
          # Add metadata
          coef_summary$age_group <- as.character(age)
          coef_summary$year <- yr
          
          # Filter to only the predictors of interest
          coef_summary <- coef_summary[coef_summary$term %in% predictors, ]
          
          # Bind to results
          results_df <- rbind(results_df, coef_summary)
        }, error = function(e) {
          # Skip if model fails
          NULL
        })
      }
    }
  }
  
  # Rename variables for clarity
  results_df <- results_df %>%
    rename(
      predictor = term,
      coefficient = estimate,
      se = std.error,
      ci_lower = conf.low,
      ci_upper = conf.high
    )
  
  # Create named color vector for proper mapping
  color_mapping <- setNames(colors[1:length(predictors)], predictors)
  
  # Create nice labels for legend
  label_mapping <- setNames(
    stringr::str_to_title(gsub("_", " ", predictors)),
    predictors
  )
  
  # Create the plot
  p <- ggplot(results_df, aes(x = year, y = coefficient, color = predictor)) +
    geom_line(linewidth = 1.2, alpha = 0.8) +
    geom_point(size = 0.8, alpha = 0.6) +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = predictor), 
                alpha = 0.15, linetype = 0) +
    facet_wrap(~ age_group, nrow = 2) +
    scale_color_manual(values = color_mapping, labels = label_mapping) +
    scale_fill_manual(values = color_mapping, labels = label_mapping) +
    labs(
      title = overall_title,
      x = x_label,
      y = y_label,
      color = "Predictor",
      fill = "Predictor"
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      strip.text = element_text(size = 11, face = "bold"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
    )
  
  # Print summary table
  summary_table <- results_df %>%
    select(age_group, year, predictor, coefficient, se, p.value, ci_lower, ci_upper) %>%
    mutate(across(where(is.numeric), ~round(., 4)))
  
  print(head(summary_table, 20))
  
  return(list(plot = p, data = summary_table))
}

# Function 2: Create prevalence/average plots
plot_prevalence_trends <- function(svy_data,
                                  variables,
                                  age_var = "age_decade_cat",
                                  year_var = "year",
                                  colors = NULL,
                                  overall_title = "Health Measure Trends by Age Group",
                                  y_label = "Average Value",
                                  x_label = "Year") {
  
  # Default colors if not provided
  if(is.null(colors)) {
    colors <- c("#E91E63", "#8BC34A", "#2196F3", "#FF9800", "#9C27B0")
  }
  
  # Get unique age groups and years
  age_groups <- unique(svy_data$variables[[age_var]])
  age_groups <- age_groups[!is.na(age_groups)]
  
  years <- unique(svy_data$variables[[year_var]])
  years <- sort(years[!is.na(years)])
  
  # Initialize results
  results_df <- data.frame()
  
  # Loop through variables, age groups, and years
  for(var in variables) {
    # Check variable type
    var_values <- svy_data$variables[[var]]
    is_binary <- all(var_values %in% c(0, 1, NA))
    
    for(age in age_groups) {
      for(yr in years) {
        # Subset survey data
        svy_subset <- subset(svy_data, 
                           get(age_var) == age & get(year_var) == yr)
        
        # Check if subset has enough data
        if(nrow(svy_subset$variables) > 30) {
          tryCatch({
            if(is_binary) {
              # Calculate weighted prevalence for binary variables
              result <- svymean(as.formula(paste("~", var)), 
                              design = svy_subset, 
                              na.rm = TRUE)
              estimate <- as.numeric(result)[1]
              se <- as.numeric(sqrt(attr(result, "var")))[1]
            } else {
              # Calculate weighted mean for continuous variables
              result <- svymean(as.formula(paste("~", var)), 
                              design = svy_subset, 
                              na.rm = TRUE)
              estimate <- as.numeric(result)[1]
              se <- as.numeric(sqrt(attr(result, "var")))[1]
            }
            
            # Calculate confidence intervals
            ci_lower <- estimate - 1.96 * se
            ci_upper <- estimate + 1.96 * se
            
            # If binary, convert to percentage
            if(is_binary) {
              estimate <- estimate * 100
              ci_lower <- ci_lower * 100
              ci_upper <- ci_upper * 100
              se <- se * 100
            }
            
            # Add to results
            new_row <- data.frame(
              variable = var,
              age_group = as.character(age),
              year = yr,
              value = estimate,
              se = se,
              ci_lower = ci_lower,
              ci_upper = ci_upper,
              type = ifelse(is_binary, "prevalence", "mean")
            )
            
            results_df <- rbind(results_df, new_row)
            
          }, error = function(e) {
            # Skip if calculation fails
            NULL
          })
        }
      }
    }
  }
  
  # Create named color vector for proper mapping
  color_mapping <- setNames(colors[1:length(variables)], variables)
  
  # Create nice labels for legend
  label_mapping <- setNames(
    stringr::str_to_title(gsub("_", " ", variables)),
    variables
  )
  
  # Create the plot
  p <- ggplot(results_df, aes(x = year, y = value, color = variable)) +
    geom_line(linewidth = 1.2, alpha = 0.8) +
    geom_point(size = 0.8, alpha = 0.6) +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = variable), 
                alpha = 0.15, linetype = 0) +
    facet_wrap(~ age_group, nrow = 2) +
    scale_color_manual(values = color_mapping, labels = label_mapping) +
    scale_fill_manual(values = color_mapping, labels = label_mapping) +
    labs(
      title = overall_title,
      x = x_label,
      y = y_label,
      color = "Health Measure",
      fill = "Health Measure"
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      strip.text = element_text(size = 11, face = "bold"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
    )
  
  # Print summary table
  summary_table <- results_df %>%
    mutate(across(where(is.numeric), ~round(., 2)))
  
  print(head(summary_table, 20))
  
  return(list(plot = p, data = summary_table))
}

# Function 3: Combine multiple plots (for side-by-side display if needed)
combine_plots <- function(plot_list, 
                         ncol = 2, 
                         main_title = "Combined Analysis") {
  
  library(patchwork)
  
  # Combine plots using patchwork
  combined <- wrap_plots(plot_list, ncol = ncol) +
    plot_annotation(
      title = main_title,
      theme = theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
    )
  
  return(combined)
}

# Example usage with your data:
# Assuming your survey object is already created as 'svy_brfss'

# Example 1: Coefficient plots
coef_results_health_days <- plot_regression_coefficients(
  svy_data = svy_brfss,
  predictors = c("physical_health", "mental_health", "usual_activities_health"),
  outcome = "srh",
  age_var = "age_decade_cat",
  year_var = "year",
  colors = c("#E91E63", "#8BC34A", "#2196F3"),
  overall_title = "Health Coefficients on Self-Rated Health",
  y_label = "Coefficient on SRH",
  x_label = "Year"
)

coef_results_health_days$plot
coef_results_health_days$data

coef_results_comorbidities <- plot_regression_coefficients(
  svy_data = svy_brfss,
  predictors = c("diabetes_dx", "htn_dx", "chd_dx", # "dep_dx", 
                 "stroke_dx", "mi_dx", "arthritis_dx" #"asthma"
                 ),
  outcome = "srh",
  age_var = "age_decade_cat",
  year_var = "year",
#  colors = c("#E91E63", "#8BC34A", "#2196F3"),
  overall_title = "Health Coefficients on Self-Rated Health",
  y_label = "Coefficient on SRH",
  x_label = "Year"
)

coef_results_comorbidities$plot
coef_results_comorbidities$data

# Display the plot
# coef_results$plot

# Access the data
# coef_data <- coef_results$data

# Example 2: Prevalence/Average plots
# prev_results <- plot_prevalence_trends(
#   svy_data = svy_brfss,
#   variables = c("physical_health_good_days", "mental_health_good_days", 
#                 "usual_activities_health_good_days"),
#   age_var = "age_decade_cat",
#   year_var = "year",
#   colors = c("#E91E63", "#8BC34A", "#2196F3"),
#   overall_title = "Trends in Health Measures",
#   y_label = "Average Good Days",
#   x_label = "Year"
# )

# Display the plot
# prev_results$plot

# Access the data
# prev_data <- prev_results$data

# Example 3: For binary variables (prevalences)
# binary_results <- plot_prevalence_trends(
#   svy_data = svy_brfss,
#   variables = c("diabetes_dx", "htn_dx", "dep_dx"),
#   age_var = "age_decade_cat",
#   year_var = "year",
#   colors = c("#FF5722", "#9C27B0", "#00BCD4"),
#   overall_title = "Disease Prevalence Trends",
#   y_label = "Prevalence (%)",
#   x_label = "Year"
# )

# Example 4: Combine multiple plots if needed
# all_plots <- list(coef_results$plot, prev_results$plot)
# combined <- combine_plots(all_plots, ncol = 2, main_title = "Health Analysis Overview")

```

